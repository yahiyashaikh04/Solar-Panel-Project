<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸŒž Solar Panel Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#f4f7f9; color:#333; }
    h1 { background:#0077b6; color:white; padding:15px; margin:0; text-align:center; }
    a, button { display:inline-block; margin:5px 5px; padding:8px 16px; background:#0096c7; color:white; border-radius:6px; text-decoration:none; border:none; cursor:pointer; font-weight:600; }
    a:hover, button:hover { background:#0077b6; }
    #statusText { text-align:center; font-weight:bold; margin-top:10px; }

    .container { display:flex; gap:20px; padding:15px; flex-wrap:wrap; }
    .left, .right { background:white; border-radius:10px; padding:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .left { flex:2; }
    .right { flex:1; min-width:250px; }

    canvas { width:100% !important; height:300px !important; margin-bottom:20px; }

    .panel-card { display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:8px; border-radius:8px; background:#f9f9f9; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .panel-left { display:flex; align-items:center; gap:10px; }
    .dot { width:14px; height:14px; border-radius:50%; }
    .status-ok { background:#2ecc71; }
    .status-fault { background:#e74c3c; }
    .panel-info { font-size:13px; color:#555; }

    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
    th, td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
    th { background:#0077b6; color:white; }

    .faulty-list { margin-top:15px; padding:10px; background:#fff3f3; border-left:5px solid #e74c3c; border-radius:6px; }
    .faulty-list li { margin-bottom:5px; }

    @media(max-width:900px){ .container { flex-direction:column; } }
  </style>
</head>
<body>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    {% for message in messages %}
      <div style="
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 10px;
        border-radius: 5px;
        width: 300px;
        margin: 10px auto;
        text-align: center;
      ">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<h1>ðŸŒž Solar Panel Monitoring Dashboard</h1>
<p id="statusText">System Monitoring...</p>

<div style="text-align:center;">
  <a href="/Update">Add Data</a>
  <a href="/delete">Delete All</a>
  <button onclick="startAutoUpdate()">Start Auto Update</button>
  <button onclick="stopAutoUpdate()">Stop Auto Update</button>
  <a href="/export">Export to CSV</a>
  <a style="margin-left: 100px;" href="/logout">Log Out</a>
</div>

<div class="container">
  <!-- LEFT: Graph -->
  <div class="left">
  <canvas id="powerChart" width="827" height="413"></canvas>

  <!-- Radio Buttons for filter -->
  <div style="text-align:center; margin-top:10px;">
    <label><input type="radio" name="filterType" value="today" checked onchange="updateFilter()"> Today</label>
    <label><input type="radio" name="filterType" value="month" onchange="updateFilter()"> Monthly</label>
    <label><input type="radio" name="filterType" value="year" onchange="updateFilter()"> Yearly</label>
  </div>

  <!-- Dropdowns (hidden until needed) -->
  <div id="monthDropdownDiv" style="text-align:center; margin-top:10px; display:none;">
    <label>Select Month:</label>
    <select id="monthDropdown" onchange="updateGraph()">
      <option value="1">January</option>
      <option value="2">February</option>
      <option value="3">March</option>
      <option value="4">April</option>
      <option value="5">May</option>
      <option value="6">June</option>
      <option value="7">July</option>
      <option value="8">August</option>
      <option value="9">September</option>
      <option value="10">October</option>
      <option value="11">November</option>
      <option value="12">December</option>
    </select>
  </div>

  <div id="yearDropdownDiv" style="text-align:center; margin-top:10px; display:none;">
    <label>Select Year:</label>
    <select id="yearDropdown" onchange="updateGraph()">
      <option value="2023">2023</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
    </select>
  </div>
</div>


  <!-- RIGHT: Panel Status -->
  <div class="right">
    <h3 style="text-align:center;color:#0077b6;">All Panels Status</h3>

    {% for g in geta %}
    <div class="panel-card">
      <div class="panel-left">
        <div class="dot {% if g.status == 'OK' or g.status == 'OK (No Sunlight)' %}status-ok{% else %}status-fault{% endif %}"></div>
        <div>
          <strong>{{ g.panel_no }}</strong><br>
          <span class="panel-info">{{ g.timestamp.strftime('%H:%M:%S') }}</span>
        </div>
      </div>
      <div>
        {% if g.status == "OK" %}
          <span style="color:#2ecc71;font-weight:700;">OK</span><br>
        {% elif g.status == "OK (No Sunlight)" %}
          <span style="color:yellowgreen;">OK (Low Sunlight)</span><br>
        {% else %}
          <span style="color:#e74c3c;font-weight:700;">FAULTY</span><br>
        {% endif %}
        <span class="panel-info">Power: {{ "%.2f"|format(g.power) }} W</span>
      </div>
    </div>
    {% endfor %}

    <!-- Summary -->
    <div style="margin-top:15px;padding:10px;background:#f0f8ff;border-radius:8px;text-align:center;">
      <strong>Total Panels:</strong> {{ total_panels }} <br>
      <strong style="color:#e74c3c;">Faulty:</strong> {{ faulty_count }} <br>
      <strong style="color:#2ecc71;">Active:</strong> {{ active_count }}
      <div>
        <h3 style="margin:0;color:#0077b6;">Total Power</h3>
        <p style="margin:4px 0;font-size:18px;font-weight:600;">{{ total_power }} W</p>
      </div>
      <div>
        <h3 style="margin:0;color:#8e44ad;">Power Balance</h3>
        <p style="margin:4px 0;font-size:18px;font-weight:600;">{{ balance_power }} W</p>
      </div>
    </div>
  </div>
</div>

<!-- Faulty Panel List -->
<div class="faulty-list">
  <strong>Faulty Panels:</strong>
  <ul>
    {% for d in data if d.status == 'Faulty' %}
      <li>{{ d.panel_no }} is FAULTY at {{ d.timestamp }}</li>
    {% else %}
      <li>No faulty panels detected âœ…</li>
    {% endfor %}
  </ul>
</div>

<h2 style="text-align:center;color:#0077b6;">ðŸ“Š Solar Panel Summary Table</h2>

<!-- YEAR SELECT DROPDOWN -->
<div style="text-align:center;margin-bottom:15px;">
  <label for="yearSelect" style="font-weight:bold;color:#0077b6;">Select Year:</label>
  <select id="yearSelect" onchange="filterByYear()" style="padding:6px 10px;border-radius:6px;">
    {% for year in years %}
      <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
    {% endfor %}
  </select>
</div>

<!-- TABLE -->
<table id="dataTable" border="1" cellspacing="0" cellpadding="6" style="width:100%;border-collapse:collapse;">
  <thead style="background:#0077b6;color:white;">
    <tr>
      <th style="width:50px;"></th>
      <th>Month</th>
      <th>Date</th>
      <th>Panel No</th>
      <th>Voltage</th>
      <th>Current</th>
      <th>Power</th>
      <th>Efficiency</th>
      <th>Status</th>
      <th>Total / Count</th>
    </tr>
  </thead>
  <tbody>
    {% for month, days in grouped.items() %}
    <!-- MONTH ROW -->
    <tr class="month-row" style="background:#0077b6;color:white;font-weight:600;">
      <td><button class="btn" onclick="toggleDays('{{ month }}')">+</button></td>
      <td>{{ month }}</td>
      <td colspan="2" style="text-align:center;">Monthly Total</td>
      <td>{{ "%.2f"|format(monthly_totals[month].voltage) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].current) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].power) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].efficiency) }}</td>
      <td>{{ monthly_totals[month].status }}</td>
      <td>{{ monthly_totals[month].count }}</td>
    </tr>

    {% for day, panels in days.items() %}
    <!-- DAY ROW -->
    <tr class="day-row month-{{ month }}" style="display:none;background:#dff6ff;font-weight:500;">
      <td><button class="btn" onclick="togglePanels('{{ month }}','{{ day }}')">+</button></td>
      <td></td>
      <td>{{ day }}</td>
      <td colspan="1" style="text-align:center;">Day Total</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='voltage')) }}</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='current')) }}</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='power')) }}</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='efficiency') / panels|length) }}</td>
      <td>Active Panels: {{ panels|length }}</td>
      <td></td>
    </tr>

    {% for p in panels %}
    <!-- PANEL ROW -->
    <tr class="panel-row month-{{ month }} day-{{ day }}" style="display:none;background:#f9f9f9;">
      <td></td>
      <td></td>
      <td>{{ p.timestamp.strftime('%Y-%m-%d') }}</td>
      <td>{{ p.panel_no }}</td>
      <td>{{ "%.2f"|format(p.voltage) }}</td>
      <td>{{ "%.2f"|format(p.current) }}</td>
      <td>{{ "%.2f"|format(p.power) }}</td>
      <td>{{ "%.2f"|format(p.efficiency) }}</td>
      <td>{{ p.status }}</td>
      <td></td>
    </tr>
    {% endfor %}
    {% endfor %}

    <!-- MONTH FOOTER -->
    <tr style="background:#caf0f8;font-weight:600;text-align:center;">
      <td colspan="4">Total for {{ month }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].voltage) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].current) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].power) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].efficiency) }}</td>
      <td colspan="2"></td>
    </tr>
    {% endfor %}

    <!-- YEAR TOTAL FOOTER -->
    <tr style="background:#90e0ef;font-weight:700;text-align:center;">
      <td colspan="4">Yearly Total</td>
      <td>{{ "%.2f"|format(yearly_totals.voltage) }}</td>
      <td>{{ "%.2f"|format(yearly_totals.current) }}</td>
      <td>{{ "%.2f"|format(yearly_totals.power) }}</td>
      <td>{{ "%.2f"|format(yearly_totals.efficiency) }}</td>
      <td colspan="2">Records: {{ yearly_totals.count }}</td>
    </tr>
  </tbody>
</table>



<script>
let intervalId = null;
let isRunning = localStorage.getItem("isRunning") === "true";

function startAutoUpdate(){
  if(!isRunning){
    isRunning=true;
    localStorage.setItem("isRunning","true");
    document.getElementById("statusText").innerText="Auto updating every 5 seconds...";
    intervalId = setInterval(updateData,5000);
  }
}
function stopAutoUpdate(){
  isRunning=false;
  localStorage.setItem("isRunning","false");
  document.getElementById("statusText").innerText="Auto update stopped";
  clearInterval(intervalId);
}
async function updateData(){
  if(isRunning){
    await fetch('/update');
    window.location.reload();
  }
}

// Chart
const allData = {{ graph_data | tojson }};
let chartInstance = null;

function filterData(filterType) {
  const now = new Date();
  return allData.filter(d => {
    const dataDate = new Date(d.timestamp);
    if (filterType === 'today') {
      return dataDate.toDateString() === now.toDateString();
    } else if (filterType === 'month') {
      const selectedMonth = parseInt(document.getElementById("monthDropdown").value);
      return dataDate.getMonth() + 1 === selectedMonth && dataDate.getFullYear() === now.getFullYear();
    } else if (filterType === 'year') {
      const selectedYear = parseInt(document.getElementById("yearDropdown").value);
      return dataDate.getFullYear() === selectedYear;
    }
    return true;
  });
}

// ðŸ§  Update both chart + table
function updateGraphAndTable() {
  const filterType = document.querySelector('input[name="filterType"]:checked').value;
  const filteredData = filterData(filterType);
  
  // === CHART UPDATE ===
  let labels = [];
  let powerValues = [];

  if (filterType === 'today') {
    labels = filteredData.map(d => d.panel_no);
    powerValues = filteredData.map(d => d.power);
  } 
  else if (filterType === 'month') {
    const dailyTotals = {};
    filteredData.forEach(d => {
      const date = new Date(d.timestamp).getDate();
      dailyTotals[date] = (dailyTotals[date] || 0) + d.power;
    });
    labels = Object.keys(dailyTotals).map(d => `Day ${d}`);
    powerValues = Object.values(dailyTotals);
  } 
  else if (filterType === 'year') {
    const monthlyTotals = {};
    filteredData.forEach(d => {
      const month = new Date(d.timestamp).getMonth() + 1;
      monthlyTotals[month] = (monthlyTotals[month] || 0) + d.power;
    });
    labels = Object.keys(monthlyTotals).map(m => monthName(m));
    powerValues = Object.values(monthlyTotals);
  }

  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('powerChart');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Power Output (W)',
        data: powerValues,
        borderColor: '#0077b6',
        backgroundColor: 'rgba(0,119,182,0.2)',
        tension: 0.3,
        fill: true
      }]
    },
    options: { scales: { y: { beginAtZero: true } } }
  });

  // === TABLE UPDATE ===
  const tableBody = document.getElementById("tableBody");
  tableBody.innerHTML = "";
  filteredData.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.panel_no}</td>
      <td>${new Date(d.timestamp).toLocaleDateString()}</td>
      <td>${d.voltage.toFixed(2)}</td>
      <td>${d.current.toFixed(2)}</td>
      <td>${d.power.toFixed(2)}</td>
      <td>${d.efficiency.toFixed(2)}</td>
      <td>${d.status}</td>
      <td>${new Date(d.timestamp).toLocaleTimeString()}</td>
    `;
    tableBody.appendChild(tr);
  });
}

// Month aur Year dropdown ke liye helper
function monthName(num) {
  const names = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return names[num-1];
}

function updateFilter() {
  const filterType = document.querySelector('input[name="filterType"]:checked').value;
  document.getElementById('monthDropdownDiv').style.display = (filterType === 'month') ? 'block' : 'none';
  document.getElementById('yearDropdownDiv').style.display = (filterType === 'year') ? 'block' : 'none';
  updateGraphAndTable();
}

document.addEventListener("DOMContentLoaded", updateGraphAndTable);

 function toggleDays(month) {
    const dayRows = document.querySelectorAll(`.day-row.month-${month}`);
    const btn = event.target;
    const isVisible = [...dayRows].some(row => row.style.display === "table-row");

    // Collapse all first
    dayRows.forEach(row => row.style.display = "none");
    document.querySelectorAll(`.panel-row.month-${month}`).forEach(row => row.style.display = "none");
    document.querySelectorAll(`.day-row.month-${month} .btn`).forEach(b => b.textContent = "+");

    if (!isVisible) {
      dayRows.forEach(row => row.style.display = "table-row");
      btn.textContent = "-";
    } else {
      btn.textContent = "+";
    }
  }

  function togglePanels(month, day) {
    const panelRows = document.querySelectorAll(`.panel-row.month-${month}.day-${day}`);
    const btn = event.target;
    const isVisible = [...panelRows].some(row => row.style.display === "table-row");

    // Collapse all panels for this day first
    panelRows.forEach(row => row.style.display = isVisible ? "none" : "table-row");

    btn.textContent = isVisible ? "+" : "-";
  }

function filterByYear(){
  const selectedYear = document.getElementById('yearSelect').value;
  window.location.href = `/main?year=${selectedYear}`;
}

</script>
</body>
</html>
