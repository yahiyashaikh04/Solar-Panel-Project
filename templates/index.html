<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ðŸŒž Solar Panel Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#f4f7f9; color:#333; }
    h1 { background:#0077b6; color:white; padding:15px; margin:0; text-align:center; }
    a, button { display:inline-block; margin:5px 5px; padding:8px 16px; background:#0096c7; color:white; border-radius:6px; text-decoration:none; border:none; cursor:pointer; font-weight:600; }
    a:hover, button:hover { background:#0077b6; }
    #statusText { text-align:center; font-weight:bold; margin-top:10px; }

    .container { display:flex; gap:20px; padding:15px; flex-wrap:wrap; }
    .left, .right { background:white; border-radius:10px; padding:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .left { flex:2; }
    .right { flex:1; min-width:250px; }

    canvas { width:100% !important; height:300px !important; margin-bottom:20px; }

    .panel-card { display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:8px; border-radius:8px; background:#f9f9f9; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .panel-left { display:flex; align-items:center; gap:10px; }
    .dot { width:14px; height:14px; border-radius:50%; }
    .status-ok { background:#2ecc71; }
    .status-fault { background:#e74c3c; }
    .panel-info { font-size:13px; color:#555; }

    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
    th, td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
    th { background:#0077b6; color:white; }

    .faulty-list { margin-top:15px; padding:10px; background:#fff3f3; border-left:5px solid #e74c3c; border-radius:6px; }
    .faulty-list li { margin-bottom:5px; }

    @media(max-width:900px){ .container { flex-direction:column; } }
  </style>
</head>
<body>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    {% for message in messages %}
      <div style="
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 10px;
        border-radius: 5px;
        width: 300px;
        margin: 10px auto;
        text-align: center;
      ">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<h1>ðŸŒž Solar Panel Monitoring Dashboard</h1>
<p id="statusText">System Monitoring...</p>

<div style="text-align:center;">
  <a href="/Update">Add Data</a>
  <a href="/delete">Delete All</a>
  <button onclick="startAutoUpdate()">Start Auto Update</button>
  <button onclick="stopAutoUpdate()">Stop Auto Update</button>
  <a href="/export">Export to CSV</a>
  <a style="margin-left: 100px;" href="/logout">Log Out</a>
</div>

<div class="container">
  <!-- LEFT: Graph -->
  <div class="left">
  <canvas id="powerChart" width="827" height="413"></canvas>

  <div style="text-align:center; margin-top:10px;">
  <label>Select Year:</label>
  <select id="graphYearSelect" onchange="handleYearChange()" style="margin-left:5px;">
    <option value="2026" selected>2026</option>
    <option value="2025">2025</option>
    <option value="2024">2024</option>
    <option value="2023">2023</option>
  </select>
</div>

<!-- ðŸ”¹ Radio Buttons for filter -->
<div style="text-align:center; margin-top:10px;">
  <label id="todayLabel"><input type="radio" name="filterType" value="today" checked onchange="updateFilter()"> Today</label>
  <label><input type="radio" name="filterType" value="month" onchange="updateFilter()"> Monthly</label>
  <label><input type="radio" name="filterType" value="year" onchange="updateFilter()"> Yearly</label>
</div>

<!-- ðŸ”¹ Dropdowns (hidden until needed, unchanged design) -->
<div id="monthDropdownDiv" style="text-align:center; margin-top:10px; display:none;">
  <label>Select Month:</label>
  <select id="monthDropdown" onchange="updateGraphAndTable()">
    <option value="1">January</option>
    <option value="2">February</option>
    <option value="3">March</option>
    <option value="4">April</option>
    <option value="5">May</option>
    <option value="6">June</option>
    <option value="7">July</option>
    <option value="8">August</option>
    <option value="9">September</option>
    <option value="10">October</option>
    <option value="11">November</option>
    <option value="12">December</option>
  </select>
</div>

<div id="yearDropdownDiv" style="text-align:center; margin-top:10px; display:none;">
  <label>Select Year:</label>
  <select id="yearDropdown" onchange="updateGraphAndTable()">
    <option value="2023">2023</option>
    <option value="2024">2024</option>
    <option value="2025">2025</option>
  </select>
</div>
</div>


  <!-- RIGHT: Panel Status -->
  <div class="right">
    <h3 style="text-align:center;color:#0077b6;">All Panels Status</h3>

    {% for g in geta %}
    <div class="panel-card">
      <div class="panel-left">
        <div class="dot {% if g.status == 'OK' or g.status == 'OK (No Sunlight)' %}status-ok{% else %}status-fault{% endif %}"></div>
        <div>
          <strong>{{ g.panel_no }}</strong><br>
          <span class="panel-info">{{ g.timestamp.strftime('%H:%M:%S') }}</span>
        </div>
      </div>
      <div>
        {% if g.status == "OK" %}
          <span style="color:#2ecc71;font-weight:700;">OK</span><br>
        {% elif g.status == "OK (No Sunlight)" %}
          <span style="color:yellowgreen;">OK (Low Sunlight)</span><br>
        {% else %}
          <span style="color:#e74c3c;font-weight:700;">FAULTY</span><br>
        {% endif %}
        <span class="panel-info">Power: {{ "%.2f"|format(g.power) }} W</span>
      </div>
    </div>
    {% endfor %}

    <!-- Summary -->
    <div style="margin-top:15px;padding:10px;background:#f0f8ff;border-radius:8px;text-align:center;">
      <strong>Total Panels:</strong> {{ total_panels }} <br>
      <strong style="color:#e74c3c;">Faulty:</strong> {{ faulty_count }} <br>
      <strong style="color:#2ecc71;">Active:</strong> {{ active_count }}
      <div>
        <h3 style="margin:0;color:#0077b6;">Total Power</h3>
        <p style="margin:4px 0;font-size:18px;font-weight:600;">{{ total_power }} W</p>
      </div>
      <div>
        <h3 style="margin:0;color:#8e44ad;">Power Balance</h3>
        <p style="margin:4px 0;font-size:18px;font-weight:600;">{{ balance_power }} W</p>
      </div>
    </div>
  </div>
</div>

<!-- Faulty Panel List -->
<div class="faulty-list">
  <strong>Faulty Panels:</strong>
  <ul>
    {% for d in data if d.status == 'Faulty' %}
      <li>{{ d.panel_no }} is FAULTY at {{ d.timestamp }}</li>
    {% else %}
      <li>No faulty panels detected âœ…</li>
    {% endfor %}
  </ul>
</div>

<h2 style="text-align:center;color:#0077b6;">ðŸ“Š Solar Panel Summary Table</h2>

<!-- YEAR SELECT DROPDOWN -->
<div style="text-align:center;margin-bottom:15px;">
  <label for="yearSelect" style="font-weight:bold;color:#0077b6;">Select Year:</label>
  <select id="yearSelect" onchange="filterByYear()" style="padding:6px 10px;border-radius:6px;">
    {% for year in years %}
      <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
    {% endfor %}
  </select>
</div>

<!-- TABLE -->
<table id="dataTable" border="1" cellspacing="0" cellpadding="6" style="width:100%;border-collapse:collapse;">
  <thead style="background:#0077b6;color:white;">
    <tr>
      <th style="width:50px;"></th>
      <th>Month</th>
      <th>Date</th>
      <th>Panel No</th>
      <th>Voltage</th>
      <th>Current</th>
      <th>Power</th>
      <th>Efficiency</th>
      <th>Status</th>
      <th>Total / Count</th>
    </tr>
  </thead>
  <tbody>
    {% for month, days in grouped.items() %}
    <!-- MONTH ROW -->
    <tr class="month-row" style="background:#0077b6;color:white;font-weight:600;">
      <td><button class="btn" onclick="toggleDays('{{ month }}')">+</button></td>
      <td>{{ month }}</td>
      <td colspan="2" style="text-align:center;">Monthly Total</td>
      <td>{{ "%.2f"|format(monthly_totals[month].voltage) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].current) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].power) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].efficiency) }}</td>
      <td>{{ monthly_totals[month].status }}</td>
      <td>{{ monthly_totals[month].count }}</td>
    </tr>

    {% for day, panels in days.items() %}
    <!-- DAY ROW -->
    <tr class="day-row month-{{ month }}" style="display:none;background:#dff6ff;font-weight:500;">
      <td><button class="btn" onclick="togglePanels('{{ month }}','{{ day }}')">+</button></td>
      <td></td>
      <td>{{ day }}</td>
      <td colspan="1" style="text-align:center;">Day Total</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='voltage')) }}</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='current')) }}</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='power')) }}</td>
      <td>{{ "%.2f"|format(panels|sum(attribute='efficiency') / panels|length) }}</td>
      <td>Active Panels: {{ panels|length }}</td>
      <td></td>
    </tr>

    {% for p in panels %}
    <!-- PANEL ROW -->
    <tr class="panel-row month-{{ month }} day-{{ day }}" style="display:none;background:#f9f9f9;">
      <td></td>
      <td></td>
      <td>{{ p.timestamp.strftime('%Y-%m-%d') }}</td>
      <td>{{ p.panel_no }}</td>
      <td>{{ "%.2f"|format(p.voltage) }}</td>
      <td>{{ "%.2f"|format(p.current) }}</td>
      <td>{{ "%.2f"|format(p.power) }}</td>
      <td>{{ "%.2f"|format(p.efficiency) }}</td>
      <td>{{ p.status }}</td>
      <td></td>
    </tr>
    {% endfor %}
    {% endfor %}

    <!-- MONTH FOOTER -->
    <tr style="background:#caf0f8;font-weight:600;text-align:center;">
      <td colspan="4">Total for {{ month }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].voltage) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].current) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].power) }}</td>
      <td>{{ "%.2f"|format(monthly_totals[month].efficiency) }}</td>
      <td colspan="2"></td>
    </tr>
    {% endfor %}

    <!-- YEAR TOTAL FOOTER -->
    <tr style="background:#90e0ef;font-weight:700;text-align:center;">
      <td colspan="4">Yearly Total</td>
      <td>{{ "%.2f"|format(yearly_totals.voltage) }}</td>
      <td>{{ "%.2f"|format(yearly_totals.current) }}</td>
      <td>{{ "%.2f"|format(yearly_totals.power) }}</td>
      <td>{{ "%.2f"|format(yearly_totals.efficiency) }}</td>
      <td colspan="2">Records: {{ yearly_totals.count }}</td>
    </tr>
  </tbody>
</table>



<script>
const allData = {{ graph_data | tojson }};
let chartInstance = null;
const currentYear = new Date().getFullYear();

/* =====================
   FILTER DATA
===================== */
function filterData(filterType) {
  const selectedYear = parseInt(
    document.getElementById("graphYearSelect").value
  );

  return allData.filter(d => {
    const dataDate = new Date(d.timestamp);

    if (filterType === "today") {
      return (
        selectedYear === currentYear &&
        dataDate.toDateString() === new Date().toDateString()
      );
    }

    if (filterType === "month") {
      const selectedMonth = parseInt(
        document.getElementById("monthDropdown").value
      );
      return (
        dataDate.getMonth() + 1 === selectedMonth &&
        dataDate.getFullYear() === selectedYear
      );
    }

    if (filterType === "year") {
      return dataDate.getFullYear() === selectedYear;
    }

    return true;
  });
}

/* =====================
   GRAPH UPDATE
===================== */
function updateGraphAndTable() {
  const filterType = document.querySelector(
    'input[name="filterType"]:checked'
  ).value;

  const filteredData = filterData(filterType);

  let labels = [];
  let powerValues = [];

  if (filterType === "today") {
    labels = filteredData.map(d => d.panel_no);
    powerValues = filteredData.map(d => d.power);
  }

  if (filterType === "month") {
    const dailyTotals = {};
    filteredData.forEach(d => {
      const day = new Date(d.timestamp).getDate();
      dailyTotals[day] = (dailyTotals[day] || 0) + d.power;
    });
    labels = Object.keys(dailyTotals).map(d => `Day ${d}`);
    powerValues = Object.values(dailyTotals);
  }

  if (filterType === "year") {
    const monthlyTotals = {};
    filteredData.forEach(d => {
      const m = new Date(d.timestamp).getMonth();
      monthlyTotals[m] = (monthlyTotals[m] || 0) + d.power;
    });
    labels = Object.keys(monthlyTotals).map(
      m => ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m]
    );
    powerValues = Object.values(monthlyTotals);
  }

  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(
    document.getElementById("powerChart"),
    {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Power Output (W)",
          data: powerValues,
          borderColor: "#0077b6",
          backgroundColor: "rgba(0,119,182,0.2)",
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    }
  );
}

/* =========================
   TOGGLE MONTH â†’ DAYS
========================= */
function toggleDays(month) {
  const rows = document.querySelectorAll(".day-row.month-" + month);
  rows.forEach(row => {
    row.style.display = (row.style.display === "none" || row.style.display === "")
      ? "table-row"
      : "none";
  });
}

/* =========================
   TOGGLE DAY â†’ PANELS
========================= */
function togglePanels(month, day) {
  const rows = document.querySelectorAll(
    ".panel-row.month-" + month + ".day-" + day
  );
  rows.forEach(row => {
    row.style.display = (row.style.display === "none" || row.style.display === "")
      ? "table-row"
      : "none";
  });
}

/* =====================
   FILTER UI
===================== */
function updateFilter() {
  const filterType = document.querySelector(
    'input[name="filterType"]:checked'
  ).value;

  document.getElementById("monthDropdownDiv").style.display =
    filterType === "month" ? "block" : "none";

  document.getElementById("yearDropdownDiv").style.display =
    filterType === "year" ? "block" : "none";

  updateGraphAndTable();
}

/* =====================
   YEAR CHANGE
===================== */
function handleYearChange() {
  const selectedYear = parseInt(
    document.getElementById("graphYearSelect").value
  );

  const todayLabel = document.getElementById("todayLabel");

  if (selectedYear !== currentYear) {
    todayLabel.style.display = "none";
    document.querySelector('input[value="month"]').checked = true;
  } else {
    todayLabel.style.display = "inline";
  }

  updateGraphAndTable();
}
function filterByYear() {
  const year = document.getElementById("yearSelect").value;
  window.location.href = "/main?year=" + year;
}

/* =====================
   INIT
===================== */
window.addEventListener("DOMContentLoaded", () => {
  handleYearChange();
  updateGraphAndTable();
});

</script>
  </body>
</html>
